name: Flake lock updater
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 6"
jobs:
  lock-updater:
    name: Flake lock updater
    runs-on: alpine-latest
    steps:
      - name: Install required packages
        run: |
          apk update
          apk add jq
      - name: Install Lix
        uses: actions/install-lix@v1
      - name: Checkout flake
        uses: actions/checkout@v6
        with:
          ref: devel
      - name: Prepare inputs to update
        id: inputs
        run: |
          INPUTS="$(nix flake metadata --json | \
            jq -r '.locks.nodes.root.inputs | to_entries | map(select(.key != "nix-secrets")) | .[].key' | \
            xargs)"
          echo "inputs=$INPUTS" >> "$GITHUB_OUTPUT"
          echo "Selected inputs: $INPUTS"
      - name: Update flake.lock
        env:
          INPUTS: ${{ steps.inputs.outputs.inputs }}
        run: |
          git config --global user.name "forgejo-actions"
          git config --global user.email "actions@localhost"
          nix flake update $INPUTS
          if [[ `git status --porcelain` ]]; then
            git pull
            git commit -am "chore: update flake.lock"
            git push
          fi
